<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>EcoSync Monitoring Dashboard</title>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 30px;
  color: #2d3748;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
}

header {
  text-align: center;
  color: white;
  margin-bottom: 40px;
}

header h1 {
  font-size: 2.8rem;
  font-weight: 700;
}

header p {
  opacity: 0.9;
  margin-top: 8px;
}

.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
  gap: 25px;
}

.card {
  background: white;
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.08);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 25px 50px rgba(0,0,0,0.12);
}

.card h2 {
  font-size: 1.3rem;
  margin-bottom: 20px;
  color: #667eea;
  font-weight: 600;
}

.metric {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid #f0f0f0;
}

.metric:last-child {
  border-bottom: none;
}

.metric-label {
  font-weight: 500;
}

.metric-value {
  font-weight: 700;
}

.status-badge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 30px;
  font-weight: 600;
  font-size: 0.9rem;
}

.status-healthy {
  background: #e6fffa;
  color: #047857;
}

.status-degraded {
  background: #fff7ed;
  color: #b45309;
}

.status-critical {
  background: #fee2e2;
  color: #b91c1c;
}

.alert-item {
  padding: 14px;
  border-radius: 10px;
  margin-bottom: 12px;
  font-size: 0.95rem;
  transition: all 0.2s ease;
}

.alert-high {
  background: #fee2e2;
  border-left: 5px solid #dc2626;
}

.alert-medium {
  background: #fff7ed;
  border-left: 5px solid #f59e0b;
}

.alert-low {
  background: #ecfdf5;
  border-left: 5px solid #10b981;
}

.emission-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
}

.timestamp {
  text-align: center;
  margin-top: 30px;
  color: white;
  opacity: 0.85;
  font-size: 0.9rem;
}

@media (max-width: 768px) {
  body { padding: 15px; }
  header h1 { font-size: 2rem; }
}
</style>
</head>

<body>

<div class="container">

<header>
  <h1>EcoSync Monitoring Dashboard</h1>
  <p>Real-time Industrial Machine Health & Emission Analytics</p>
</header>

<div class="dashboard">

  <div class="card">
    <h2>System Status</h2>
    <div id="status-health"></div>
    <div id="status-details"></div>
  </div>

  <div class="card">
    <h2>Active Alerts</h2>
    <div id="alerts-list">No alerts</div>
  </div>

  <div class="card">
    <h2>Machine Emissions</h2>
    <div id="emissions-list">No data</div>
  </div>

</div>

<div class="timestamp" id="last-update">Waiting for data...</div>

</div>

<script>
(() => {

const alertsList = document.getElementById("alerts-list");
const emissionsList = document.getElementById("emissions-list");
const statusHealth = document.getElementById("status-health");
const statusDetails = document.getElementById("status-details");
const lastUpdate = document.getElementById("last-update");

function renderStatus(status) {
  if (!status) return;

  let cls = "status-healthy";
  if (status.system_health === "DEGRADED") cls = "status-degraded";
  if (status.system_health === "CRITICAL") cls = "status-critical";

  statusHealth.innerHTML =
    `<span class="status-badge ${cls}">
      ${status.system_health}
     </span>`;

  statusDetails.innerHTML = `
    <div class="metric"><span class="metric-label">Active Machines</span><span class="metric-value">${status.active_machines}</span></div>
    <div class="metric"><span class="metric-label">Total Records</span><span class="metric-value">${status.total_records_processed}</span></div>
    <div class="metric"><span class="metric-label">Anomalies</span><span class="metric-value">${status.total_anomalies_detected}</span></div>
    <div class="metric"><span class="metric-label">Avg CO₂ / Machine</span><span class="metric-value">${Number(status.avg_co2_per_machine || 0).toFixed(3)} kg</span></div>
  `;
}

function renderAlerts(alerts) {
  alertsList.innerHTML = "";
  if (!alerts || alerts.length === 0) {
    alertsList.textContent = "No alerts";
    return;
  }

  alerts.forEach(a => {
    let cls = "alert-low";
    if (a.severity === "HIGH") cls = "alert-high";
    if (a.severity === "MEDIUM") cls = "alert-medium";

    const d = document.createElement("div");
    d.className = `alert-item ${cls}`;
    d.innerHTML = `
      <strong>${a.machine_id}</strong> — ${a.anomaly_type}<br>
      Temp: ${a.current_temperature} | Vib: ${a.current_vibration}<br>
      <small>${a.alert_time}</small>
    `;
    alertsList.appendChild(d);
  });
}

function renderEmissions(emissions) {
  emissionsList.innerHTML = "";
  if (!emissions || emissions.length === 0) {
    emissionsList.textContent = "No data";
    return;
  }

  emissions.forEach(e => {
    const d = document.createElement("div");
    d.className = "emission-row";
    d.innerHTML = `
      <span>${e.machine_id}</span>
      <span><strong>${Number(e.cumulative_co2_kg).toFixed(3)} kg</strong></span>
    `;
    emissionsList.appendChild(d);
  });
}

const es = new EventSource("/api/v1/stream");

es.onmessage = (ev) => {
  try {
    const obj = JSON.parse(ev.data);
    if (!obj || !obj.type) return;

    if (obj.type === "alerts") renderAlerts(obj.data);
    if (obj.type === "emissions") renderEmissions(obj.data);
    if (obj.type === "status") renderStatus(obj.data);

    lastUpdate.textContent = "Last updated: " + (obj.last_update || new Date().toISOString());
  } catch (e) {
    console.error("SSE parse error", e);
  }
};

})();
</script>

</body>
</html>