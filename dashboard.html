<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>EcoSync Sentinel</title>

<style>
* { margin:0; padding:0; box-sizing:border-box; }

body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: linear-gradient(135deg,#6a82fb,#8f5bd6);
    min-height:100vh;
    padding:40px;
}

.container {
    max-width:1400px;
    margin:auto;
}

/* HEADER */
header {
    text-align:center;
    color:white;
    margin-bottom:30px;
}

header h1 {
    font-size:3rem;
    font-weight:700;
}

header p {
    margin-top:8px;
    opacity:0.9;
}

/* CONTROL BAR */
.controls {
    background:#f4f4f7;
    padding:20px;
    border-radius:14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
    margin-bottom:30px;
    flex-wrap:wrap;
}

.controls-left {
    display:flex;
    gap:15px;
    flex-wrap:wrap;
}

button {
    background:#6a82fb;
    color:white;
    border:none;
    padding:10px 18px;
    border-radius:8px;
    cursor:pointer;
    font-size:0.95rem;
    transition:0.2s ease;
}

button:hover { background:#5a72e5; }

button.secondary {
    background:#9aa0b8;
}

button.secondary:hover {
    background:#7f859e;
}

.status-indicator {
    font-weight:600;
}

.status-dot {
    display:inline-block;
    width:10px;
    height:10px;
    border-radius:50%;
    margin-right:6px;
}

.connected { background:#16a34a; }
.connecting { background:#f59e0b; }
.disconnected { background:#dc2626; }

/* CARDS */
.dashboard {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
    gap:25px;
}

.card {
    background:#f4f4f7;
    padding:25px;
    border-radius:14px;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
    min-height:200px;
}

.card h2 {
    font-size:1.2rem;
    margin-bottom:15px;
    border-bottom:2px solid #6a82fb;
    padding-bottom:8px;
    color:#4b5563;
}

/* METRICS */
.metric {
    display:flex;
    justify-content:space-between;
    padding:8px 0;
    font-size:0.95rem;
}

.metric strong {
    font-weight:600;
}

/* ALERTS */
.alert-item {
    padding:10px;
    border-radius:8px;
    margin-bottom:10px;
    font-size:0.9rem;
}

.alert-high {
    background:#fee2e2;
    border-left:4px solid #dc2626;
}

.alert-medium {
    background:#fef3c7;
    border-left:4px solid #f59e0b;
}

.alert-low {
    background:#dcfce7;
    border-left:4px solid #16a34a;
}

/* EMISSIONS */
.emission-row {
    display:flex;
    justify-content:space-between;
    padding:6px 0;
}

.timestamp {
    text-align:center;
    margin-top:25px;
    color:white;
    opacity:0.85;
    font-size:0.9rem;
}

@media(max-width:768px){
    body { padding:20px; }
}
</style>
</head>

<body>

<div class="container">

<header>
    <h1>üåø EcoSync Sentinel</h1>
    <p>Real-time AI for Green Manufacturing</p>
</header>

<div class="controls">
    <div class="controls-left">
        <button onclick="manualRefresh()">üîÑ Refresh Now</button>
        <button onclick="toggleAuto()" id="autoBtn">‚è± Enable Auto-Refresh</button>
        <button class="secondary" onclick="clearAlerts()">üóë Clear Alerts</button>
    </div>

    <div class="status-indicator">
        API Status:
        <span class="status-dot connecting" id="apiDot"></span>
        <span id="apiStatusText">Connecting...</span>
    </div>
</div>

<div class="dashboard">

    <div class="card">
        <h2>üìä System Status</h2>
        <div id="status-content">Loading...</div>
    </div>

    <div class="card">
        <h2>üö® Recent Alerts</h2>
        <div id="alerts-content">Loading...</div>
    </div>

    <div class="card">
        <h2>üåç Carbon Emissions</h2>
        <div id="emissions-content">Loading...</div>
    </div>

</div>

<div class="timestamp" id="lastUpdate">Waiting for data...</div>

</div>

<script>
let autoRefresh = false;
let autoInterval = null;
let cachedAlerts = [];

const apiDot = document.getElementById("apiDot");
const apiStatusText = document.getElementById("apiStatusText");

function setApiStatus(state) {
    apiDot.className = "status-dot " + state;
    apiStatusText.textContent = state.charAt(0).toUpperCase() + state.slice(1);
}

function renderStatus(status) {
    if(!status) return;
    document.getElementById("status-content").innerHTML = `
        <div class="metric"><span>System Health</span><strong>${status.system_health}</strong></div>
        <div class="metric"><span>Active Machines</span><strong>${status.active_machines}</strong></div>
        <div class="metric"><span>Total Records</span><strong>${status.total_records_processed}</strong></div>
        <div class="metric"><span>Anomalies</span><strong>${status.total_anomalies_detected}</strong></div>
        <div class="metric"><span>Avg CO‚ÇÇ / Machine</span><strong>${Number(status.avg_co2_per_machine).toFixed(3)} kg</strong></div>
    `;
}

function renderAlerts(alerts) {
    cachedAlerts = alerts || [];
    const el = document.getElementById("alerts-content");
    el.innerHTML = "";

    if(!alerts || alerts.length === 0){
        el.textContent = "No alerts";
        return;
    }

    alerts.forEach(a=>{
        let cls="alert-low";
        if(a.severity==="HIGH") cls="alert-high";
        if(a.severity==="MEDIUM") cls="alert-medium";

        const div=document.createElement("div");
        div.className="alert-item "+cls;
        div.innerHTML=`
            <strong>${a.machine_id}</strong> ‚Äî ${a.anomaly_type}<br>
            Temp: ${a.current_temperature} | Vib: ${a.current_vibration}<br>
            <small>${a.alert_time}</small>
        `;
        el.appendChild(div);
    });
}

function renderEmissions(emissions){
    const el=document.getElementById("emissions-content");
    el.innerHTML="";
    if(!emissions||emissions.length===0){
        el.textContent="No data";
        return;
    }
    emissions.forEach(e=>{
        const div=document.createElement("div");
        div.className="emission-row";
        div.innerHTML=`
            <span>${e.machine_id}</span>
            <strong>${Number(e.cumulative_co2_kg).toFixed(3)} kg</strong>
        `;
        el.appendChild(div);
    });
}

function manualRefresh(){
    fetchAll();
}

function toggleAuto(){
    autoRefresh=!autoRefresh;
    const btn=document.getElementById("autoBtn");
    if(autoRefresh){
        btn.textContent="‚èπ Disable Auto-Refresh";
        autoInterval=setInterval(fetchAll,3000);
    }else{
        btn.textContent="‚è± Enable Auto-Refresh";
        clearInterval(autoInterval);
    }
}

function clearAlerts(){
    cachedAlerts=[];
    renderAlerts([]);
}

function fetchAll(){
    fetch("/api/v1/status").then(r=>r.json()).then(renderStatus);
    fetch("/api/v1/alerts").then(r=>r.json()).then(renderAlerts);
    fetch("/api/v1/emissions").then(r=>r.json()).then(renderEmissions);
}

const es=new EventSource("/api/v1/stream");

es.onopen=()=>setApiStatus("connected");
es.onerror=()=>setApiStatus("disconnected");

es.onmessage=(ev)=>{
    setApiStatus("connected");
    const obj=JSON.parse(ev.data);
    if(obj.type==="status") renderStatus(obj.data);
    if(obj.type==="alerts") renderAlerts(obj.data);
    if(obj.type==="emissions") renderEmissions(obj.data);
    document.getElementById("lastUpdate").textContent=
        "Last updated: "+(obj.last_update||new Date().toISOString());
};
</script>

</body>
</html>